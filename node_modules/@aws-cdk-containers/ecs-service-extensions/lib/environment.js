"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.ImportedEnvironment = exports.Environment = void 0;
const ec2 = require("@aws-cdk/aws-ec2");
const ecs = require("@aws-cdk/aws-ecs");
const extension_interfaces_1 = require("./extensions/extension-interfaces");
// keep this import separate from other imports to reduce chance for merge conflicts with v2-main
// eslint-disable-next-line no-duplicate-imports, import/order
const core_1 = require("@aws-cdk/core");
/**
 * An environment into which to deploy a service. This environment
 * can either be instantiated with a pre-existing AWS VPC and ECS cluster,
 * or it can create its own VPC and cluster. By default, it will create
 * a cluster with Fargate capacity.
 */
class Environment extends core_1.Construct {
    constructor(scope, id, props) {
        super(scope, id);
        this.scope = scope;
        this.id = id;
        if (props && props.vpc) {
            this.vpc = props.vpc;
        }
        else {
            this.vpc = new ec2.Vpc(this.scope, `${this.id}-environment-vpc`);
        }
        if (props && props.cluster) {
            this.cluster = props.cluster;
        }
        else {
            this.cluster = new ecs.Cluster(this.scope, `${this.id}-environment-cluster`, { vpc: this.vpc });
        }
        if (props && props.capacityType) {
            this.capacityType = props.capacityType;
        }
        else {
            this.capacityType = extension_interfaces_1.EnvironmentCapacityType.FARGATE;
        }
    }
    /**
     * Import an existing environment from its attributes.
     */
    static fromEnvironmentAttributes(scope, id, attrs) {
        return new ImportedEnvironment(scope, id, attrs);
    }
    /**
     * Add a default cloudmap namespace to the environment's cluster.
     */
    addDefaultCloudMapNamespace(options) {
        this.cluster.addDefaultCloudMapNamespace(options);
    }
}
exports.Environment = Environment;
class ImportedEnvironment extends core_1.Construct {
    constructor(scope, id, props) {
        super(scope, id);
        this.id = id;
        this.capacityType = props.capacityType;
        this.cluster = props.cluster;
        this.vpc = props.cluster.vpc;
    }
    /**
     * Adding a default cloudmap namespace to the cluster will throw an error, as we don't
     * own it.
     */
    addDefaultCloudMapNamespace(_options) {
        throw new Error('the cluster environment is immutable when imported');
    }
}
exports.ImportedEnvironment = ImportedEnvironment;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZW52aXJvbm1lbnQuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJlbnZpcm9ubWVudC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7QUFBQSx3Q0FBd0M7QUFDeEMsd0NBQXdDO0FBRXhDLDRFQUE0RTtBQUU1RSxpR0FBaUc7QUFDakcsOERBQThEO0FBQzlELHdDQUEwQztBQTJEMUM7Ozs7O0dBS0c7QUFDSCxNQUFhLFdBQVksU0FBUSxnQkFBUztJQThCeEMsWUFBWSxLQUFnQixFQUFFLEVBQVUsRUFBRSxLQUF3QjtRQUNoRSxLQUFLLENBQUMsS0FBSyxFQUFFLEVBQUUsQ0FBQyxDQUFDO1FBRWpCLElBQUksQ0FBQyxLQUFLLEdBQUcsS0FBSyxDQUFDO1FBQ25CLElBQUksQ0FBQyxFQUFFLEdBQUcsRUFBRSxDQUFDO1FBRWIsSUFBSSxLQUFLLElBQUksS0FBSyxDQUFDLEdBQUcsRUFBRTtZQUN0QixJQUFJLENBQUMsR0FBRyxHQUFHLEtBQUssQ0FBQyxHQUFHLENBQUM7U0FDdEI7YUFBTTtZQUNMLElBQUksQ0FBQyxHQUFHLEdBQUcsSUFBSSxHQUFHLENBQUMsR0FBRyxDQUFDLElBQUksQ0FBQyxLQUFLLEVBQUUsR0FBRyxJQUFJLENBQUMsRUFBRSxrQkFBa0IsQ0FBQyxDQUFDO1NBQ2xFO1FBRUQsSUFBSSxLQUFLLElBQUksS0FBSyxDQUFDLE9BQU8sRUFBRTtZQUMxQixJQUFJLENBQUMsT0FBTyxHQUFHLEtBQUssQ0FBQyxPQUFPLENBQUM7U0FDOUI7YUFBTTtZQUNMLElBQUksQ0FBQyxPQUFPLEdBQUcsSUFBSSxHQUFHLENBQUMsT0FBTyxDQUFDLElBQUksQ0FBQyxLQUFLLEVBQUUsR0FBRyxJQUFJLENBQUMsRUFBRSxzQkFBc0IsRUFBRSxFQUFFLEdBQUcsRUFBRSxJQUFJLENBQUMsR0FBRyxFQUFFLENBQUMsQ0FBQztTQUNqRztRQUVELElBQUksS0FBSyxJQUFJLEtBQUssQ0FBQyxZQUFZLEVBQUU7WUFDL0IsSUFBSSxDQUFDLFlBQVksR0FBRyxLQUFLLENBQUMsWUFBWSxDQUFDO1NBQ3hDO2FBQU07WUFDTCxJQUFJLENBQUMsWUFBWSxHQUFHLDhDQUF1QixDQUFDLE9BQU8sQ0FBQztTQUNyRDtJQUNILENBQUM7SUFwREQ7O09BRUc7SUFDSSxNQUFNLENBQUMseUJBQXlCLENBQUMsS0FBZ0IsRUFBRSxFQUFVLEVBQUUsS0FBNEI7UUFDaEcsT0FBTyxJQUFJLG1CQUFtQixDQUFDLEtBQUssRUFBRSxFQUFFLEVBQUUsS0FBSyxDQUFDLENBQUM7SUFDbkQsQ0FBQztJQWlERDs7T0FFRztJQUNILDJCQUEyQixDQUFDLE9BQXFDO1FBQy9ELElBQUksQ0FBQyxPQUFPLENBQUMsMkJBQTJCLENBQUMsT0FBTyxDQUFDLENBQUM7SUFDcEQsQ0FBQztDQUNGO0FBN0RELGtDQTZEQztBQWNELE1BQWEsbUJBQW9CLFNBQVEsZ0JBQVM7SUFNaEQsWUFBWSxLQUFnQixFQUFFLEVBQVUsRUFBRSxLQUE0QjtRQUNwRSxLQUFLLENBQUMsS0FBSyxFQUFFLEVBQUUsQ0FBQyxDQUFDO1FBRWpCLElBQUksQ0FBQyxFQUFFLEdBQUcsRUFBRSxDQUFDO1FBQ2IsSUFBSSxDQUFDLFlBQVksR0FBRyxLQUFLLENBQUMsWUFBWSxDQUFDO1FBQ3ZDLElBQUksQ0FBQyxPQUFPLEdBQUcsS0FBSyxDQUFDLE9BQU8sQ0FBQztRQUM3QixJQUFJLENBQUMsR0FBRyxHQUFHLEtBQUssQ0FBQyxPQUFPLENBQUMsR0FBRyxDQUFDO0lBQy9CLENBQUM7SUFFRDs7O09BR0c7SUFDSCwyQkFBMkIsQ0FBQyxRQUFzQztRQUNoRSxNQUFNLElBQUksS0FBSyxDQUFDLG9EQUFvRCxDQUFDLENBQUM7SUFDeEUsQ0FBQztDQUNGO0FBdEJELGtEQXNCQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCAqIGFzIGVjMiBmcm9tICdAYXdzLWNkay9hd3MtZWMyJztcbmltcG9ydCAqIGFzIGVjcyBmcm9tICdAYXdzLWNkay9hd3MtZWNzJztcbmltcG9ydCAqIGFzIGNkayBmcm9tICdAYXdzLWNkay9jb3JlJztcbmltcG9ydCB7IEVudmlyb25tZW50Q2FwYWNpdHlUeXBlIH0gZnJvbSAnLi9leHRlbnNpb25zL2V4dGVuc2lvbi1pbnRlcmZhY2VzJztcblxuLy8ga2VlcCB0aGlzIGltcG9ydCBzZXBhcmF0ZSBmcm9tIG90aGVyIGltcG9ydHMgdG8gcmVkdWNlIGNoYW5jZSBmb3IgbWVyZ2UgY29uZmxpY3RzIHdpdGggdjItbWFpblxuLy8gZXNsaW50LWRpc2FibGUtbmV4dC1saW5lIG5vLWR1cGxpY2F0ZS1pbXBvcnRzLCBpbXBvcnQvb3JkZXJcbmltcG9ydCB7IENvbnN0cnVjdCB9IGZyb20gJ0Bhd3MtY2RrL2NvcmUnO1xuXG4vKipcbiAqIFNldHRpbmdzIGZvciB0aGUgZW52aXJvbm1lbnQgd2hlcmUgeW91IHdhbnQgdG8gZGVwbG95IHlvdXIgc2VydmljZXMuXG4gKi9cbmV4cG9ydCBpbnRlcmZhY2UgRW52aXJvbm1lbnRQcm9wcyB7XG4gIC8qKlxuICAgKiBUaGUgVlBDIHVzZWQgYnkgdGhlIHNlcnZpY2UgZm9yIG5ldHdvcmtpbmcuXG4gICAqXG4gICAqIEBkZWZhdWx0IC0gQ3JlYXRlIGEgbmV3IFZQQ1xuICAgKi9cbiAgcmVhZG9ubHkgdnBjPzogZWMyLklWcGMsXG5cbiAgLyoqXG4gICAqIFRoZSBFQ1MgY2x1c3RlciB3aGljaCBwcm92aWRlcyBjb21wdXRlIGNhcGFjaXR5IHRvIHRoaXMgc2VydmljZS5cbiAgICpcbiAgICogW2Rpc2FibGUtYXdzbGludDpyZWYtdmlhLWludGVyZmFjZV1cbiAgICogQGRlZmF1bHQgLSBDcmVhdGUgYSBuZXcgY2x1c3RlclxuICAgKi9cbiAgcmVhZG9ubHkgY2x1c3Rlcj86IGVjcy5DbHVzdGVyXG5cbiAgLyoqXG4gICAqIFRoZSB0eXBlIG9mIGNhcGFjaXR5IHRvIHVzZSBmb3IgdGhpcyBlbnZpcm9ubWVudC5cbiAgICpcbiAgICogQGRlZmF1bHQgLSBFbnZpcm9ubWVudENhcGFjaXR5VHlwZS5GQVJHQVRFXG4gICAqL1xuICByZWFkb25seSBjYXBhY2l0eVR5cGU/OiBFbnZpcm9ubWVudENhcGFjaXR5VHlwZVxufVxuXG4vKipcbiAqIEFuIGVudmlyb25tZW50IGludG8gd2hpY2ggdG8gZGVwbG95IGEgc2VydmljZS5cbiAqL1xuZXhwb3J0IGludGVyZmFjZSBJRW52aXJvbm1lbnQge1xuICAvKipcbiAgICogVGhlIG5hbWUgb2YgdGhpcyBlbnZpcm9ubWVudC5cbiAgICovXG4gIHJlYWRvbmx5IGlkOiBzdHJpbmc7XG5cbiAgLyoqXG4gICAqIFRoZSBWUEMgaW50byB3aGljaCBlbnZpcm9ubWVudCBzZXJ2aWNlcyBzaG91bGQgYmUgcGxhY2VkLlxuICAgKi9cbiAgcmVhZG9ubHkgdnBjOiBlYzIuSVZwYztcblxuICAvKipcbiAgICogVGhlIGNsdXN0ZXIgdGhhdCBpcyBwcm92aWRpbmcgY2FwYWNpdHkgZm9yIHRoaXMgc2VydmljZS5cbiAgICovXG4gIHJlYWRvbmx5IGNsdXN0ZXI6IGVjcy5JQ2x1c3RlcjtcblxuICAvKipcbiAgICogVGhlIGNhcGFjaXR5IHR5cGUgdXNlZCBieSB0aGUgc2VydmljZSdzIGNsdXN0ZXIuXG4gICAqL1xuICByZWFkb25seSBjYXBhY2l0eVR5cGU6IEVudmlyb25tZW50Q2FwYWNpdHlUeXBlO1xuXG4gIC8qKlxuICAgKiBBZGQgYSBkZWZhdWx0IGNsb3VkbWFwIG5hbWVzcGFjZSB0byB0aGUgZW52aXJvbm1lbnQncyBjbHVzdGVyLlxuICAgKi9cbiAgYWRkRGVmYXVsdENsb3VkTWFwTmFtZXNwYWNlKG9wdGlvbnM6IGVjcy5DbG91ZE1hcE5hbWVzcGFjZU9wdGlvbnMpOiB2b2lkO1xufVxuXG4vKipcbiAqIEFuIGVudmlyb25tZW50IGludG8gd2hpY2ggdG8gZGVwbG95IGEgc2VydmljZS4gVGhpcyBlbnZpcm9ubWVudFxuICogY2FuIGVpdGhlciBiZSBpbnN0YW50aWF0ZWQgd2l0aCBhIHByZS1leGlzdGluZyBBV1MgVlBDIGFuZCBFQ1MgY2x1c3RlcixcbiAqIG9yIGl0IGNhbiBjcmVhdGUgaXRzIG93biBWUEMgYW5kIGNsdXN0ZXIuIEJ5IGRlZmF1bHQsIGl0IHdpbGwgY3JlYXRlXG4gKiBhIGNsdXN0ZXIgd2l0aCBGYXJnYXRlIGNhcGFjaXR5LlxuICovXG5leHBvcnQgY2xhc3MgRW52aXJvbm1lbnQgZXh0ZW5kcyBDb25zdHJ1Y3QgaW1wbGVtZW50cyBJRW52aXJvbm1lbnQge1xuICAvKipcbiAgICogSW1wb3J0IGFuIGV4aXN0aW5nIGVudmlyb25tZW50IGZyb20gaXRzIGF0dHJpYnV0ZXMuXG4gICAqL1xuICBwdWJsaWMgc3RhdGljIGZyb21FbnZpcm9ubWVudEF0dHJpYnV0ZXMoc2NvcGU6IENvbnN0cnVjdCwgaWQ6IHN0cmluZywgYXR0cnM6IEVudmlyb25tZW50QXR0cmlidXRlcyk6IElFbnZpcm9ubWVudCB7XG4gICAgcmV0dXJuIG5ldyBJbXBvcnRlZEVudmlyb25tZW50KHNjb3BlLCBpZCwgYXR0cnMpO1xuICB9XG5cbiAgLyoqXG4gICAqIFRoZSBuYW1lIG9mIHRoaXMgZW52aXJvbm1lbnQuXG4gICAqL1xuICBwdWJsaWMgcmVhZG9ubHkgaWQ6IHN0cmluZztcblxuICAvKipcbiAgICogVGhlIFZQQyB3aGVyZSBlbnZpcm9ubWVudCBzZXJ2aWNlcyBzaG91bGQgYmUgcGxhY2VkLlxuICAgKi9cbiAgcHVibGljIHJlYWRvbmx5IHZwYzogZWMyLklWcGM7XG5cbiAgLyoqXG4gICAqIFRoZSBjbHVzdGVyIHRoYXQgaXMgcHJvdmlkaW5nIGNhcGFjaXR5IGZvciB0aGlzIHNlcnZpY2UuXG4gICAqL1xuICBwdWJsaWMgcmVhZG9ubHkgY2x1c3RlcjogZWNzLkNsdXN0ZXI7XG5cbiAgLyoqXG4gICAqIFRoZSBjYXBhY2l0eSB0eXBlIHVzZWQgYnkgdGhlIHNlcnZpY2UncyBjbHVzdGVyLlxuICAgKi9cbiAgcHVibGljIHJlYWRvbmx5IGNhcGFjaXR5VHlwZTogRW52aXJvbm1lbnRDYXBhY2l0eVR5cGU7XG5cbiAgcHJpdmF0ZSByZWFkb25seSBzY29wZTogY2RrLkNvbnN0cnVjdDtcblxuICBjb25zdHJ1Y3RvcihzY29wZTogQ29uc3RydWN0LCBpZDogc3RyaW5nLCBwcm9wcz86IEVudmlyb25tZW50UHJvcHMpIHtcbiAgICBzdXBlcihzY29wZSwgaWQpO1xuXG4gICAgdGhpcy5zY29wZSA9IHNjb3BlO1xuICAgIHRoaXMuaWQgPSBpZDtcblxuICAgIGlmIChwcm9wcyAmJiBwcm9wcy52cGMpIHtcbiAgICAgIHRoaXMudnBjID0gcHJvcHMudnBjO1xuICAgIH0gZWxzZSB7XG4gICAgICB0aGlzLnZwYyA9IG5ldyBlYzIuVnBjKHRoaXMuc2NvcGUsIGAke3RoaXMuaWR9LWVudmlyb25tZW50LXZwY2ApO1xuICAgIH1cblxuICAgIGlmIChwcm9wcyAmJiBwcm9wcy5jbHVzdGVyKSB7XG4gICAgICB0aGlzLmNsdXN0ZXIgPSBwcm9wcy5jbHVzdGVyO1xuICAgIH0gZWxzZSB7XG4gICAgICB0aGlzLmNsdXN0ZXIgPSBuZXcgZWNzLkNsdXN0ZXIodGhpcy5zY29wZSwgYCR7dGhpcy5pZH0tZW52aXJvbm1lbnQtY2x1c3RlcmAsIHsgdnBjOiB0aGlzLnZwYyB9KTtcbiAgICB9XG5cbiAgICBpZiAocHJvcHMgJiYgcHJvcHMuY2FwYWNpdHlUeXBlKSB7XG4gICAgICB0aGlzLmNhcGFjaXR5VHlwZSA9IHByb3BzLmNhcGFjaXR5VHlwZTtcbiAgICB9IGVsc2Uge1xuICAgICAgdGhpcy5jYXBhY2l0eVR5cGUgPSBFbnZpcm9ubWVudENhcGFjaXR5VHlwZS5GQVJHQVRFO1xuICAgIH1cbiAgfVxuXG4gIC8qKlxuICAgKiBBZGQgYSBkZWZhdWx0IGNsb3VkbWFwIG5hbWVzcGFjZSB0byB0aGUgZW52aXJvbm1lbnQncyBjbHVzdGVyLlxuICAgKi9cbiAgYWRkRGVmYXVsdENsb3VkTWFwTmFtZXNwYWNlKG9wdGlvbnM6IGVjcy5DbG91ZE1hcE5hbWVzcGFjZU9wdGlvbnMpIHtcbiAgICB0aGlzLmNsdXN0ZXIuYWRkRGVmYXVsdENsb3VkTWFwTmFtZXNwYWNlKG9wdGlvbnMpO1xuICB9XG59XG5cbmV4cG9ydCBpbnRlcmZhY2UgRW52aXJvbm1lbnRBdHRyaWJ1dGVzIHtcbiAgLyoqXG4gICAqIFRoZSBjYXBhY2l0eSB0eXBlIHVzZWQgYnkgdGhlIHNlcnZpY2UncyBjbHVzdGVyLlxuICAgKi9cbiAgY2FwYWNpdHlUeXBlOiBFbnZpcm9ubWVudENhcGFjaXR5VHlwZTtcblxuICAvKipcbiAgICogVGhlIGNsdXN0ZXIgdGhhdCBpcyBwcm92aWRpbmcgY2FwYWNpdHkgZm9yIHRoaXMgc2VydmljZS5cbiAgICovXG4gIGNsdXN0ZXI6IGVjcy5JQ2x1c3Rlcjtcbn1cblxuZXhwb3J0IGNsYXNzIEltcG9ydGVkRW52aXJvbm1lbnQgZXh0ZW5kcyBDb25zdHJ1Y3QgaW1wbGVtZW50cyBJRW52aXJvbm1lbnQge1xuICBwdWJsaWMgcmVhZG9ubHkgY2FwYWNpdHlUeXBlOiBFbnZpcm9ubWVudENhcGFjaXR5VHlwZTtcbiAgcHVibGljIHJlYWRvbmx5IGNsdXN0ZXI6IGVjcy5JQ2x1c3RlcjtcbiAgcHVibGljIHJlYWRvbmx5IGlkOiBzdHJpbmc7XG4gIHB1YmxpYyByZWFkb25seSB2cGM6IGVjMi5JVnBjO1xuXG4gIGNvbnN0cnVjdG9yKHNjb3BlOiBDb25zdHJ1Y3QsIGlkOiBzdHJpbmcsIHByb3BzOiBFbnZpcm9ubWVudEF0dHJpYnV0ZXMpIHtcbiAgICBzdXBlcihzY29wZSwgaWQpO1xuXG4gICAgdGhpcy5pZCA9IGlkO1xuICAgIHRoaXMuY2FwYWNpdHlUeXBlID0gcHJvcHMuY2FwYWNpdHlUeXBlO1xuICAgIHRoaXMuY2x1c3RlciA9IHByb3BzLmNsdXN0ZXI7XG4gICAgdGhpcy52cGMgPSBwcm9wcy5jbHVzdGVyLnZwYztcbiAgfVxuXG4gIC8qKlxuICAgKiBBZGRpbmcgYSBkZWZhdWx0IGNsb3VkbWFwIG5hbWVzcGFjZSB0byB0aGUgY2x1c3RlciB3aWxsIHRocm93IGFuIGVycm9yLCBhcyB3ZSBkb24ndFxuICAgKiBvd24gaXQuXG4gICAqL1xuICBhZGREZWZhdWx0Q2xvdWRNYXBOYW1lc3BhY2UoX29wdGlvbnM6IGVjcy5DbG91ZE1hcE5hbWVzcGFjZU9wdGlvbnMpIHtcbiAgICB0aHJvdyBuZXcgRXJyb3IoJ3RoZSBjbHVzdGVyIGVudmlyb25tZW50IGlzIGltbXV0YWJsZSB3aGVuIGltcG9ydGVkJyk7XG4gIH1cbn1cbiJdfQ==