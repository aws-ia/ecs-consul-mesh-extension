"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.TaskRecordManager = void 0;
const path = require("path");
const dynamodb = require("@aws-cdk/aws-dynamodb");
const events = require("@aws-cdk/aws-events");
const events_targets = require("@aws-cdk/aws-events-targets");
const iam = require("@aws-cdk/aws-iam");
const lambda = require("@aws-cdk/aws-lambda");
const lambda_es = require("@aws-cdk/aws-lambda-event-sources");
const sqs = require("@aws-cdk/aws-sqs");
const cdk = require("@aws-cdk/core");
const customresources = require("@aws-cdk/custom-resources");
// keep this import separate from other imports to reduce chance for merge conflicts with v2-main
// eslint-disable-next-line no-duplicate-imports, import/order
const core_1 = require("@aws-cdk/core");
/**
 * An event-driven serverless app to maintain a list of public ips in a Route 53
 * hosted zone.
 */
class TaskRecordManager extends core_1.Construct {
    constructor(scope, id, props) {
        super(scope, id);
        // Poison pills go here.
        const deadLetterQueue = new sqs.Queue(this, 'EventsDL', {
            retentionPeriod: cdk.Duration.days(14),
        });
        // Time limit for processing queue items - we set the lambda time limit to
        // this value as well.
        const eventsQueueVisibilityTimeout = cdk.Duration.seconds(30);
        // This queue lets us batch together ecs task state events. This is useful
        // for when when we would be otherwise bombarded by them.
        const eventsQueue = new sqs.Queue(this, 'EventsQueue', {
            deadLetterQueue: {
                maxReceiveCount: 500,
                queue: deadLetterQueue,
            },
            visibilityTimeout: eventsQueueVisibilityTimeout,
        });
        // Storage for task and record set information.
        const recordsTable = new dynamodb.Table(this, 'Records', {
            partitionKey: {
                name: 'cluster_service',
                type: dynamodb.AttributeType.STRING,
            },
            billingMode: dynamodb.BillingMode.PAY_PER_REQUEST,
            removalPolicy: cdk.RemovalPolicy.DESTROY,
        });
        // Put the cluster's task state changes events into the queue.
        const runningEventRule = new events.Rule(this, 'RuleRunning', {
            eventPattern: {
                source: ['aws.ecs'],
                detailType: ['ECS Task State Change'],
                detail: {
                    clusterArn: [props.service.cluster.clusterArn],
                    lastStatus: ['RUNNING'],
                    desiredStatus: ['RUNNING'],
                },
            },
            targets: [
                new events_targets.SqsQueue(eventsQueue),
            ],
        });
        const stoppedEventRule = new events.Rule(this, 'RuleStopped', {
            eventPattern: {
                source: ['aws.ecs'],
                detailType: ['ECS Task State Change'],
                detail: {
                    clusterArn: [props.service.cluster.clusterArn],
                    lastStatus: ['STOPPED'],
                    desiredStatus: ['STOPPED'],
                },
            },
            targets: [
                new events_targets.SqsQueue(eventsQueue),
            ],
        });
        // Shared codebase for the lambdas.
        const code = lambda.Code.fromAsset(path.join(__dirname, 'lambda'), {
            exclude: [
                '.coverage',
                '*.pyc',
                '.idea',
            ],
        });
        // Fully qualified domain name of the record
        const recordFqdn = cdk.Fn.join('.', [props.dnsRecordName, props.dnsZone.zoneName]);
        // Allow access to manage a zone's records.
        const dnsPolicyStatement = new iam.PolicyStatement({
            effect: iam.Effect.ALLOW,
            actions: [
                'route53:ChangeResourceRecordSets',
                'route53:ListResourceRecordSets',
            ],
            resources: [props.dnsZone.hostedZoneArn],
        });
        // This function consumes events from the event queue and does the work of
        // querying task IP addresses and creating, updating record sets. When there
        // are zero tasks, it deletes the record set.
        const eventHandler = new lambda.Function(this, 'EventHandler', {
            code: code,
            handler: 'index.queue_handler',
            runtime: lambda.Runtime.PYTHON_3_8,
            timeout: eventsQueueVisibilityTimeout,
            // Single-concurrency to prevent a race to set the RecordSet
            reservedConcurrentExecutions: 1,
            environment: {
                HOSTED_ZONE_ID: props.dnsZone.hostedZoneId,
                RECORD_NAME: recordFqdn,
                RECORDS_TABLE: recordsTable.tableName,
                CLUSTER_ARN: props.service.cluster.clusterArn,
                SERVICE_NAME: props.service.serviceName,
            },
            events: [
                new lambda_es.SqsEventSource(eventsQueue),
            ],
            initialPolicy: [
                // Look up task IPs
                new iam.PolicyStatement({
                    effect: iam.Effect.ALLOW,
                    actions: ['ec2:DescribeNetworkInterfaces'],
                    resources: ['*'],
                }),
                dnsPolicyStatement,
            ],
        });
        recordsTable.grantReadWriteData(eventHandler);
        // The lambda for a custom resource provider that deletes dangling record
        // sets when the stack is deleted.
        const cleanupResourceProviderHandler = new lambda.Function(this, 'CleanupResourceProviderHandler', {
            code: code,
            handler: 'index.cleanup_resource_handler',
            runtime: lambda.Runtime.PYTHON_3_8,
            timeout: cdk.Duration.minutes(5),
            initialPolicy: [
                dnsPolicyStatement,
            ],
        });
        const cleanupResourceProvider = new customresources.Provider(this, 'CleanupResourceProvider', {
            onEventHandler: cleanupResourceProviderHandler,
        });
        const cleanupResource = new cdk.CustomResource(this, 'Cleanup', {
            serviceToken: cleanupResourceProvider.serviceToken,
            properties: {
                HostedZoneId: props.dnsZone.hostedZoneId,
                RecordName: recordFqdn,
            },
        });
        // Prime the event queue with a message so that changes to dns config are
        // quickly applied.
        const primingSdkCall = {
            service: 'SQS',
            action: 'sendMessage',
            parameters: {
                QueueUrl: eventsQueue.queueUrl,
                DelaySeconds: 10,
                MessageBody: '{ "prime": true }',
                // Add the hosted zone id and record name so that priming occurs with
                // dns config updates.
                MessageAttributes: {
                    HostedZoneId: { DataType: 'String', StringValue: props.dnsZone.hostedZoneId },
                    RecordName: { DataType: 'String', StringValue: props.dnsRecordName },
                },
            },
            physicalResourceId: customresources.PhysicalResourceId.fromResponse('MessageId'),
        };
        const primingCall = new customresources.AwsCustomResource(this, 'PrimingCall', {
            onCreate: primingSdkCall,
            onUpdate: primingSdkCall,
            policy: customresources.AwsCustomResourcePolicy.fromStatements([
                new iam.PolicyStatement({
                    effect: iam.Effect.ALLOW,
                    actions: ['sqs:SendMessage'],
                    resources: [eventsQueue.queueArn],
                }),
            ]),
        });
        // Send the priming call after the handler is created/updated.
        primingCall.node.addDependency(eventHandler);
        // Ensure that the cleanup resource is deleted last (so it can clean up)
        props.service.taskDefinition.node.addDependency(cleanupResource);
        // Ensure that the event rules are created first so we can catch the first
        // state transitions.
        props.service.taskDefinition.node.addDependency(runningEventRule);
        props.service.taskDefinition.node.addDependency(stoppedEventRule);
    }
}
exports.TaskRecordManager = TaskRecordManager;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidGFzay1yZWNvcmQtbWFuYWdlci5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbInRhc2stcmVjb3JkLW1hbmFnZXIudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7O0FBQUEsNkJBQTZCO0FBQzdCLGtEQUFrRDtBQUVsRCw4Q0FBOEM7QUFDOUMsOERBQThEO0FBQzlELHdDQUF3QztBQUN4Qyw4Q0FBOEM7QUFDOUMsK0RBQStEO0FBRS9ELHdDQUF3QztBQUN4QyxxQ0FBcUM7QUFDckMsNkRBQTZEO0FBRTdELGlHQUFpRztBQUNqRyw4REFBOEQ7QUFDOUQsd0NBQTBDO0FBUTFDOzs7R0FHRztBQUNILE1BQWEsaUJBQWtCLFNBQVEsZ0JBQVM7SUFDOUMsWUFBWSxLQUFnQixFQUFFLEVBQVUsRUFBRSxLQUE2QjtRQUNyRSxLQUFLLENBQUMsS0FBSyxFQUFFLEVBQUUsQ0FBQyxDQUFDO1FBRWpCLHdCQUF3QjtRQUN4QixNQUFNLGVBQWUsR0FBRyxJQUFJLEdBQUcsQ0FBQyxLQUFLLENBQUMsSUFBSSxFQUFFLFVBQVUsRUFBRTtZQUN0RCxlQUFlLEVBQUUsR0FBRyxDQUFDLFFBQVEsQ0FBQyxJQUFJLENBQUMsRUFBRSxDQUFDO1NBQ3ZDLENBQUMsQ0FBQztRQUVILDBFQUEwRTtRQUMxRSxzQkFBc0I7UUFDdEIsTUFBTSw0QkFBNEIsR0FBRyxHQUFHLENBQUMsUUFBUSxDQUFDLE9BQU8sQ0FBQyxFQUFFLENBQUMsQ0FBQztRQUU5RCwwRUFBMEU7UUFDMUUseURBQXlEO1FBQ3pELE1BQU0sV0FBVyxHQUFHLElBQUksR0FBRyxDQUFDLEtBQUssQ0FBQyxJQUFJLEVBQUUsYUFBYSxFQUFFO1lBQ3JELGVBQWUsRUFBRTtnQkFDZixlQUFlLEVBQUUsR0FBRztnQkFDcEIsS0FBSyxFQUFFLGVBQWU7YUFDdkI7WUFDRCxpQkFBaUIsRUFBRSw0QkFBNEI7U0FDaEQsQ0FBQyxDQUFDO1FBRUgsK0NBQStDO1FBQy9DLE1BQU0sWUFBWSxHQUFHLElBQUksUUFBUSxDQUFD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QUMsaUJBQWlCLENBQUM7b0JBQzVCLFNBQVMsRUFBRSxDQUFDLFdBQVcsQ0FBQyxRQUFRLENBQUM7aUJBQ2xDLENBQUM7YUFDSCxDQUFDO1NBQ0gsQ0FBQyxDQUFDO1FBRUgsOERBQThEO1FBQzlELFdBQVcsQ0FBQyxJQUFJLENBQUMsYUFBYSxDQUFDLFlBQVksQ0FBQyxDQUFDO1FBRTdDLHdFQUF3RTtRQUN4RSxLQUFLLENBQUMsT0FBTyxDQUFDLGNBQWMsQ0FBQyxJQUFJLENBQUMsYUFBYSxDQUFDLGVBQWUsQ0FBQyxDQUFDO1FBQ2pFLDBFQUEwRTtRQUMxRSxxQkFBcUI7UUFDckIsS0FBSyxDQUFDLE9BQU8sQ0FBQyxjQUFjLENBQUMsSUFBSSxDQUFDLGFBQWEsQ0FBQyxnQkFBZ0IsQ0FBQyxDQUFDO1FBQ2xFLEtBQUssQ0FBQyxPQUFPLENBQUMsY0FBYyxDQUFDLElBQUksQ0FBQyxhQUFhLENBQUMsZ0JBQWdCLENBQUMsQ0FBQztJQUNwRSxDQUFDO0NBQ0Y7QUF2TEQsOENBdUxDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0ICogYXMgcGF0aCBmcm9tICdwYXRoJztcbmltcG9ydCAqIGFzIGR5bmFtb2RiIGZyb20gJ0Bhd3MtY2RrL2F3cy1keW5hbW9kYic7XG5pbXBvcnQgKiBhcyBlY3MgZnJvbSAnQGF3cy1jZGsvYXdzLWVjcyc7XG5pbXBvcnQgKiBhcyBldmVudHMgZnJvbSAnQGF3cy1jZGsvYXdzLWV2ZW50cyc7XG5pbXBvcnQgKiBhcyBldmVudHNfdGFyZ2V0cyBmcm9tICdAYXdzLWNkay9hd3MtZXZlbnRzLXRhcmdldHMnO1xuaW1wb3J0ICogYXMgaWFtIGZyb20gJ0Bhd3MtY2RrL2F3cy1pYW0nO1xuaW1wb3J0ICogYXMgbGFtYmRhIGZyb20gJ0Bhd3MtY2RrL2F3cy1sYW1iZGEnO1xuaW1wb3J0ICogYXMgbGFtYmRhX2VzIGZyb20gJ0Bhd3MtY2RrL2F3cy1sYW1iZGEtZXZlbnQtc291cmNlcyc7XG5pbXBvcnQgKiBhcyByb3V0ZTUzIGZyb20gJ0Bhd3MtY2RrL2F3cy1yb3V0ZTUzJztcbmltcG9ydCAqIGFzIHNxcyBmcm9tICdAYXdzLWNkay9hd3Mtc3FzJztcbmltcG9ydCAqIGFzIGNkayBmcm9tICdAYXdzLWNkay9jb3JlJztcbmltcG9ydCAqIGFzIGN1c3RvbXJlc291cmNlcyBmcm9tICdAYXdzLWNkay9jdXN0b20tcmVzb3VyY2VzJztcblxuLy8ga2VlcCB0aGlzIGltcG9ydCBzZXBhcmF0ZSBmcm9tIG90aGVyIGltcG9ydHMgdG8gcmVkdWNlIGNoYW5jZSBmb3IgbWVyZ2UgY29uZmxpY3RzIHdpdGggdjItbWFpblxuLy8gZXNsaW50LWRpc2FibGUtbmV4dC1saW5lIG5vLWR1cGxpY2F0ZS1pbXBvcnRzLCBpbXBvcnQvb3JkZXJcbmltcG9ydCB7IENvbnN0cnVjdCB9IGZyb20gJ0Bhd3MtY2RrL2NvcmUnO1xuXG5leHBvcnQgaW50ZXJmYWNlIFRhc2tSZWNvcmRNYW5hZ2VyUHJvcHMge1xuICBzZXJ2aWNlOiBlY3MuRWMyU2VydmljZSB8IGVjcy5GYXJnYXRlU2VydmljZTtcbiAgZG5zWm9uZTogcm91dGU1My5JSG9zdGVkWm9uZTtcbiAgZG5zUmVjb3JkTmFtZTogc3RyaW5nO1xufVxuXG4vKipcbiAqIEFuIGV2ZW50LWRyaXZlbiBzZXJ2ZXJsZXNzIGFwcCB0byBtYWludGFpbiBhIGxpc3Qgb2YgcHVibGljIGlwcyBpbiBhIFJvdXRlIDUzXG4gKiBob3N0ZWQgem9uZS5cbiAqL1xuZXhwb3J0IGNsYXNzIFRhc2tSZWNvcmRNYW5hZ2VyIGV4dGVuZHMgQ29uc3RydWN0IHtcbiAgY29uc3RydWN0b3Ioc2NvcGU6IENvbnN0cnVjdCwgaWQ6IHN0cmluZywgcHJvcHM6IFRhc2tSZWNvcmRNYW5hZ2VyUHJvcHMpIHtcbiAgICBzdXBlcihzY29wZSwgaWQpO1xuXG4gICAgLy8gUG9pc29uIHBpbGxzIGdvIGhlcmUuXG4gICAgY29uc3QgZGVhZExldHRlclF1ZXVlID0gbmV3IHNxcy5RdWV1ZSh0aGlzLCAnRXZlbnRzREwnLCB7XG4gICAgICByZXRlbnRpb25QZXJpb2Q6IGNkay5EdXJhdGlvbi5kYXlzKDE0KSxcbiAgICB9KTtcblxuICAgIC8vIFRpbWUgbGltaXQgZm9yIHByb2Nlc3NpbmcgcXVldWUgaXRlbXMgLSB3ZSBzZXQgdGhlIGxhbWJkYSB0aW1lIGxpbWl0IHRvXG4gICAgLy8gdGhpcyB2YWx1ZSBhcyB3ZWxsLlxuICAgIGNvbnN0IGV2ZW50c1F1ZXVlVmlzaWJpbGl0eVRpbWVvdXQgPSBjZGsuRHVyYXRpb24uc2Vjb25kcygzMCk7XG5cbiAgICAvLyBUaGlzIHF1ZXVlIGxldHMgdXMgYmF0Y2ggdG9nZXRoZXIgZWNzIHRhc2sgc3RhdGUgZXZlbnRzLiBUaGlzIGlzIHVzZWZ1bFxuICAgIC8vIGZvciB3aGVuIHdoZW4gd2Ugd291bGQgYmUgb3RoZXJ3aXNlIGJvbWJhcmRlZCBieSB0aGVtLlxuICAgIGNvbnN0IGV2ZW50c1F1ZXVlID0gbmV3IHNxcy5RdWV1ZSh0aGlzLCAnRXZlbnRzUXVldWUnLCB7XG4gICAgICBkZWFkTGV0dGVyUXVldWU6IHtcbiAgICAgICAgbWF4UmVjZWl2ZUNvdW50OiA1MDAsXG4gICAgICAgIHF1ZXVlOiBkZWFkTGV0dGVyUXVldWUsXG4gICAgICB9LFxuICAgICAgdmlzaWJpbGl0eVRpbWVvdXQ6IGV2ZW50c1F1ZXVlVmlzaWJpbGl0eVRpbWVvdXQsXG4gICAgfSk7XG5cbiAgICAvLyBTdG9yYWdlIGZvciB0YXNrIGFuZCByZWNvcmQgc2V0IGluZm9ybWF0aW9uLlxuICAgIGNvbnN0IHJlY29yZHNUYWJsZSA9IG5ldyBkeW5hbW9kYi5UYWJsZSh0aGlzLCAnUmVjb3JkcycsIHtcbiAgICAgIHBhcnRpdGlvbktleToge1xuICAgICAgICBuYW1lOiAnY2x1c3Rlcl9zZXJ2aWNlJyxcbiAgICAgICAgdHlwZTogZHluYW1vZGIuQXR0cmlidXRlVHlwZS5TVFJJTkcsXG4gICAgICB9LFxuICAgICAgYmlsbGluZ01vZGU6IGR5bmFtb2RiLkJpbGxpbmdNb2RlLlBBWV9QRVJfUkVRVUVTVCxcbiAgICAgIHJlbW92YWxQb2xpY3k6IGNkay5SZW1vdmFsUG9saWN5LkRFU1RST1ksXG4gICAgfSk7XG5cbiAgICAvLyBQdXQgdGhlIGNsdXN0ZXIncyB0YXNrIHN0YXRlIGNoYW5nZXMgZXZlbnRzIGludG8gdGhlIHF1ZXVlLlxuICAgIGNvbnN0IHJ1bm5pbmdFdmVudFJ1bGUgPSBuZXcgZXZlbnRzLlJ1bGUodGhpcywgJ1J1bGVSdW5uaW5nJywge1xuICAgICAgZXZlbnRQYXR0ZXJuOiB7XG4gICAgICAgIHNvdXJjZTogWydhd3MuZWNzJ10sXG4gICAgICAgIGRldGFpbFR5cGU6IFsnRUNTIFRhc2sgU3RhdGUgQ2hhbmdlJ10sXG4gICAgICAgIGRldGFpbDoge1xuICAgICAgICAgIGNsdXN0ZXJBcm46IFtwcm9wcy5zZXJ2aWNlLmNsdXN0ZXIuY2x1c3RlckFybl0sXG4gICAgICAgICAgbGFzdFN0YXR1czogWydSVU5OSU5HJ10sXG4gICAgICAgICAgZGVzaXJlZFN0YXR1czogWydSVU5OSU5HJ10sXG4gICAgICAgIH0sXG4gICAgICB9LFxuICAgICAgdGFyZ2V0czogW1xuICAgICAgICBuZXcgZXZlbnRzX3RhcmdldHMuU3FzUXVldWUoZXZlbnRzUXVldWUpLFxuICAgICAgXSxcbiAgICB9KTtcblxuICAgIGNvbnN0IHN0b3BwZWRFdmVudFJ1bGUgPSBuZXcgZXZlbnRzLlJ1bGUodGhpcywgJ1J1bGVTdG9wcGVkJywge1xuICAgICAgZXZlbnRQYXR0ZXJuOiB7XG4gICAgICAgIHNvdXJjZTogWydhd3MuZWNzJ10sXG4gICAgICAgIGRldGFpbFR5cGU6IFsnRUNTIFRhc2sgU3RhdGUgQ2hhbmdlJ10sXG4gICAgICAgIGRldGFpbDoge1xuICAgICAgICAgIGNsdXN0ZXJBcm46IFtwcm9wcy5zZXJ2aWNlLmNsdXN0ZXIuY2x1c3RlckFybl0sXG4gICAgICAgICAgbGFzdFN0YXR1czogWydTVE9QUEVEJ10sXG4gICAgICAgICAgZGVzaXJlZFN0YXR1czogWydTVE9QUEVEJ10sXG4gICAgICAgIH0sXG4gICAgICB9LFxuICAgICAgdGFyZ2V0czogW1xuICAgICAgICBuZXcgZXZlbnRzX3RhcmdldHMuU3FzUXVldWUoZXZlbnRzUXVldWUpLFxuICAgICAgXSxcbiAgICB9KTtcblxuICAgIC8vIFNoYXJlZCBjb2RlYmFzZSBmb3IgdGhlIGxhbWJkYXMuXG4gICAgY29uc3QgY29kZSA9IGxhbWJkYS5Db2RlLmZyb21Bc3NldChwYXRoLmpvaW4oX19kaXJuYW1lLCAnbGFtYmRhJyksIHtcbiAgICAgIGV4Y2x1ZGU6IFtcbiAgICAgICAgJy5jb3ZlcmFnZScsXG4gICAgICAgICcqLnB5YycsXG4gICAgICAgICcuaWRlYScsXG4gICAgICBdLFxuICAgIH0pO1xuXG4gICAgLy8gRnVsbHkgcXVhbGlmaWVkIGRvbWFpbiBuYW1lIG9mIHRoZSByZWNvcmRcbiAgICBjb25zdCByZWNvcmRGcWRuID0gY2RrLkZuLmpvaW4oJy4nLCBbcHJvcHMuZG5zUmVjb3JkTmFtZSwgcHJvcHMuZG5zWm9uZS56b25lTmFtZV0pO1xuXG4gICAgLy8gQWxsb3cgYWNjZXNzIHRvIG1hbmFnZSBhIHpvbmUncyByZWNvcmRzLlxuICAgIGNvbnN0IGRuc1BvbGljeVN0YXRlbWVudCA9IG5ldyBpYW0uUG9saWN5U3RhdGVtZW50KHtcbiAgICAgIGVmZmVjdDogaWFtLkVmZmVjdC5BTExPVyxcbiAgICAgIGFjdGlvbnM6IFtcbiAgICAgICAgJ3JvdXRlNTM6Q2hhbmdlUmVzb3VyY2VSZWNvcmRTZXRzJyxcbiAgICAgICAgJ3JvdXRlNTM6TGlzdFJlc291cmNlUmVjb3JkU2V0cycsXG4gICAgICBdLFxuICAgICAgcmVzb3VyY2VzOiBbcHJvcHMuZG5zWm9uZS5ob3N0ZWRab25lQXJuXSxcbiAgICB9KTtcblxuICAgIC8vIFRoaXMgZnVuY3Rpb24gY29uc3VtZXMgZXZlbnRzIGZyb20gdGhlIGV2ZW50IHF1ZXVlIGFuZCBkb2VzIHRoZSB3b3JrIG9mXG4gICAgLy8gcXVlcnlpbmcgdGFzayBJUCBhZGRyZXNzZXMgYW5kIGNyZWF0aW5nLCB1cGRhdGluZyByZWNvcmQgc2V0cy4gV2hlbiB0aGVyZVxuICAgIC8vIGFyZSB6ZXJvIHRhc2tzLCBpdCBkZWxldGVzIHRoZSByZWNvcmQgc2V0LlxuICAgIGNvbnN0IGV2ZW50SGFuZGxlciA9IG5ldyBsYW1iZGEuRnVuY3Rpb24odGhpcywgJ0V2ZW50SGFuZGxlcicsIHtcbiAgICAgIGNvZGU6IGNvZGUsXG4gICAgICBoYW5kbGVyOiAnaW5kZXgucXVldWVfaGFuZGxlcicsXG4gICAgICBydW50aW1lOiBsYW1iZGEuUnVudGltZS5QWVRIT05fM184LFxuICAgICAgdGltZW91dDogZXZlbnRzUXVldWVWaXNpYmlsaXR5VGltZW91dCxcbiAgICAgIC8vIFNpbmdsZS1jb25jdXJyZW5jeSB0byBwcmV2ZW50IGEgcmFjZSB0byBzZXQgdGhlIFJlY29yZFNldFxuICAgICAgcmVzZXJ2ZWRDb25jdXJyZW50RXhlY3V0aW9uczogMSxcbiAgICAgIGVudmlyb25tZW50OiB7XG4gICAgICAgIEhPU1RFRF9aT05FX0lEOiBwcm9wcy5kbnNab25lLmhvc3RlZFpvbmVJZCxcbiAgICAgICAgUkVDT1JEX05BTUU6IHJlY29yZEZxZG4sXG4gICAgICAgIFJFQ09SRFNfVEFCTEU6IHJlY29yZHNUYWJsZS50YWJsZU5hbWUsXG4gICAgICAgIENMVVNURVJfQVJOOiBwcm9wcy5zZXJ2aWNlLmNsdXN0ZXIuY2x1c3RlckFybixcbiAgICAgICAgU0VSVklDRV9OQU1FOiBwcm9wcy5zZXJ2aWNlLnNlcnZpY2VOYW1lLFxuICAgICAgfSxcbiAgICAgIGV2ZW50czogW1xuICAgICAgICBuZXcgbGFtYmRhX2VzLlNxc0V2ZW50U291cmNlKGV2ZW50c1F1ZXVlKSxcbiAgICAgIF0sXG4gICAgICBpbml0aWFsUG9saWN5OiBbXG4gICAgICAgIC8vIExvb2sgdXAgdGFzayBJUHNcbiAgICAgICAgbmV3IGlhbS5Qb2xpY3lTdGF0ZW1lbnQoe1xuICAgICAgICAgIGVmZmVjdDogaWFtLkVmZmVjdC5BTExPVyxcbiAgICAgICAgICBhY3Rpb25zOiBbJ2VjMjpEZXNjcmliZU5ldHdvcmtJbnRlcmZhY2VzJ10sXG4gICAgICAgICAgcmVzb3VyY2VzOiBbJyonXSxcbiAgICAgICAgfSksXG4gICAgICAgIGRuc1BvbGljeVN0YXRlbWVudCxcbiAgICAgIF0sXG4gICAgfSk7XG4gICAgcmVjb3Jkc1RhYmxlLmdyYW50UmVhZFdyaXRlRGF0YShldmVudEhhbmRsZXIpO1xuXG4gICAgLy8gVGhlIGxhbWJkYSBmb3IgYSBjdXN0b20gcmVzb3VyY2UgcHJvdmlkZXIgdGhhdCBkZWxldGVzIGRhbmdsaW5nIHJlY29yZFxuICAgIC8vIHNldHMgd2hlbiB0aGUgc3RhY2sgaXMgZGVsZXRlZC5cbiAgICBjb25zdCBjbGVhbnVwUmVzb3VyY2VQcm92aWRlckhhbmRsZXIgPSBuZXcgbGFtYmRhLkZ1bmN0aW9uKHRoaXMsICdDbGVhbnVwUmVzb3VyY2VQcm92aWRlckhhbmRsZXInLCB7XG4gICAgICBjb2RlOiBjb2RlLFxuICAgICAgaGFuZGxlcjogJ2luZGV4LmNsZWFudXBfcmVzb3VyY2VfaGFuZGxlcicsXG4gICAgICBydW50aW1lOiBsYW1iZGEuUnVudGltZS5QWVRIT05fM184LFxuICAgICAgdGltZW91dDogY2RrLkR1cmF0aW9uLm1pbnV0ZXMoNSksXG4gICAgICBpbml0aWFsUG9saWN5OiBbXG4gICAgICAgIGRuc1BvbGljeVN0YXRlbWVudCxcbiAgICAgIF0sXG4gICAgfSk7XG5cbiAgICBjb25zdCBjbGVhbnVwUmVzb3VyY2VQcm92aWRlciA9IG5ldyBjdXN0b21yZXNvdXJjZXMuUHJvdmlkZXIodGhpcywgJ0NsZWFudXBSZXNvdXJjZVByb3ZpZGVyJywge1xuICAgICAgb25FdmVudEhhbmRsZXI6IGNsZWFudXBSZXNvdXJjZVByb3ZpZGVySGFuZGxlcixcbiAgICB9KTtcblxuICAgIGNvbnN0IGNsZWFudXBSZXNvdXJjZSA9IG5ldyBjZGsuQ3VzdG9tUmVzb3VyY2UodGhpcywgJ0NsZWFudXAnLCB7XG4gICAgICBzZXJ2aWNlVG9rZW46IGNsZWFudXBSZXNvdXJjZVByb3ZpZGVyLnNlcnZpY2VUb2tlbixcbiAgICAgIHByb3BlcnRpZXM6IHtcbiAgICAgICAgSG9zdGVkWm9uZUlkOiBwcm9wcy5kbnNab25lLmhvc3RlZFpvbmVJZCxcbiAgICAgICAgUmVjb3JkTmFtZTogcmVjb3JkRnFkbixcbiAgICAgIH0sXG4gICAgfSk7XG5cbiAgICAvLyBQcmltZSB0aGUgZXZlbnQgcXVldWUgd2l0aCBhIG1lc3NhZ2Ugc28gdGhhdCBjaGFuZ2VzIHRvIGRucyBjb25maWcgYXJlXG4gICAgLy8gcXVpY2tseSBhcHBsaWVkLlxuICAgIGNvbnN0IHByaW1pbmdTZGtDYWxsOiBjdXN0b21yZXNvdXJjZXMuQXdzU2RrQ2FsbCA9IHtcbiAgICAgIHNlcnZpY2U6ICdTUVMnLFxuICAgICAgYWN0aW9uOiAnc2VuZE1lc3NhZ2UnLFxuICAgICAgcGFyYW1ldGVyczoge1xuICAgICAgICBRdWV1ZVVybDogZXZlbnRzUXVldWUucXVldWVVcmwsXG4gICAgICAgIERlbGF5U2Vjb25kczogMTAsXG4gICAgICAgIE1lc3NhZ2VCb2R5OiAneyBcInByaW1lXCI6IHRydWUgfScsXG4gICAgICAgIC8vIEFkZCB0aGUgaG9zdGVkIHpvbmUgaWQgYW5kIHJlY29yZCBuYW1lIHNvIHRoYXQgcHJpbWluZyBvY2N1cnMgd2l0aFxuICAgICAgICAvLyBkbnMgY29uZmlnIHVwZGF0ZXMuXG4gICAgICAgIE1lc3NhZ2VBdHRyaWJ1dGVzOiB7XG4gICAgICAgICAgSG9zdGVkWm9uZUlkOiB7IERhdGFUeXBlOiAnU3RyaW5nJywgU3RyaW5nVmFsdWU6IHByb3BzLmRuc1pvbmUuaG9zdGVkWm9uZUlkIH0sXG4gICAgICAgICAgUmVjb3JkTmFtZTogeyBEYXRhVHlwZTogJ1N0cmluZycsIFN0cmluZ1ZhbHVlOiBwcm9wcy5kbnNSZWNvcmROYW1lIH0sXG4gICAgICAgIH0sXG4gICAgICB9LFxuICAgICAgcGh5c2ljYWxSZXNvdXJjZUlkOiBjdXN0b21yZXNvdXJjZXMuUGh5c2ljYWxSZXNvdXJjZUlkLmZyb21SZXNwb25zZSgnTWVzc2FnZUlkJyksXG4gICAgfTtcblxuICAgIGNvbnN0IHByaW1pbmdDYWxsID0gbmV3IGN1c3RvbXJlc291cmNlcy5Bd3NDdXN0b21SZXNvdXJjZSh0aGlzLCAnUHJpbWluZ0NhbGwnLCB7XG4gICAgICBvbkNyZWF0ZTogcHJpbWluZ1Nka0NhbGwsXG4gICAgICBvblVwZGF0ZTogcHJpbWluZ1Nka0NhbGwsXG4gICAgICBwb2xpY3k6IGN1c3RvbXJlc291cmNlcy5Bd3NDdXN0b21SZXNvdXJjZVBvbGljeS5mcm9tU3RhdGVtZW50cyhbXG4gICAgICAgIG5ldyBpYW0uUG9saWN5U3RhdGVtZW50KHtcbiAgICAgICAgICBlZmZlY3Q6IGlhbS5FZmZlY3QuQUxMT1csXG4gICAgICAgICAgYWN0aW9uczogWydzcXM6U2VuZE1lc3NhZ2UnXSxcbiAgICAgICAgICByZXNvdXJjZXM6IFtldmVudHNRdWV1ZS5xdWV1ZUFybl0sXG4gICAgICAgIH0pLFxuICAgICAgXSksXG4gICAgfSk7XG5cbiAgICAvLyBTZW5kIHRoZSBwcmltaW5nIGNhbGwgYWZ0ZXIgdGhlIGhhbmRsZXIgaXMgY3JlYXRlZC91cGRhdGVkLlxuICAgIHByaW1pbmdDYWxsLm5vZGUuYWRkRGVwZW5kZW5jeShldmVudEhhbmRsZXIpO1xuXG4gICAgLy8gRW5zdXJlIHRoYXQgdGhlIGNsZWFudXAgcmVzb3VyY2UgaXMgZGVsZXRlZCBsYXN0IChzbyBpdCBjYW4gY2xlYW4gdXApXG4gICAgcHJvcHMuc2VydmljZS50YXNrRGVmaW5pdGlvbi5ub2RlLmFkZERlcGVuZGVuY3koY2xlYW51cFJlc291cmNlKTtcbiAgICAvLyBFbnN1cmUgdGhhdCB0aGUgZXZlbnQgcnVsZXMgYXJlIGNyZWF0ZWQgZmlyc3Qgc28gd2UgY2FuIGNhdGNoIHRoZSBmaXJzdFxuICAgIC8vIHN0YXRlIHRyYW5zaXRpb25zLlxuICAgIHByb3BzLnNlcnZpY2UudGFza0RlZmluaXRpb24ubm9kZS5hZGREZXBlbmRlbmN5KHJ1bm5pbmdFdmVudFJ1bGUpO1xuICAgIHByb3BzLnNlcnZpY2UudGFza0RlZmluaXRpb24ubm9kZS5hZGREZXBlbmRlbmN5KHN0b3BwZWRFdmVudFJ1bGUpO1xuICB9XG59XG4iXX0=